---
// src/pages/docs/index.astro
import { getCollection } from 'astro:content'
import Layout from '@/layouts/Layout.astro'
import Wave from 'react-wavify'

const docs = await getCollection('docs')

const grouped = docs.reduce<Record<string, typeof docs[number][]>>((acc, doc) => {
  const cat = doc.data.category || 'Uncategorized'
  acc[cat] = acc[cat] ? [...acc[cat], doc] : [doc]
  return acc
}, {})

const categories = Object.keys(grouped).sort()
categories.forEach(cat => {
  grouped[cat].sort((a, b) => a.data.title.localeCompare(b.data.title))
})
---

<Layout
  title="Docs"
  heroImage="https://github.com/pokepetter/ld44_life_is_currency/blob/master/value_of_life_screenshot.jpg?raw=true"
  heroDesc="Documentation for the Ursina Engine"
>
  <!-- Docs Listing -->
  <section class="py-16 bg-background/95 dark:bg-background">
    <div class="container mx-auto px-6 flex gap-8">
      <!-- Sidebar -->
      <aside class="w-64 sticky top-24 self-start">
        <input
          type="text"
          id="searchDocs"
          placeholder="Searchâ€¦"
          class="
            w-full mb-4 p-2
            border border-border
            bg-input dark:bg-input
            text-foreground dark:text-foreground
            rounded
          "
        />
        <nav class="space-y-6">
          {categories.map((cat) => (
            <>
              <h4 class="font-semibold text-sidebar-foreground dark:text-sidebar-foreground">
                {cat}
              </h4>
              {grouped[cat].map((doc) => (
                <a
                  href={`/docs/${doc.slug}`}
                  class="
                    block px-3 py-1 rounded
                    text-sidebar-foreground dark:text-sidebar-foreground
                    hover:bg-sidebar-accent/95 dark:hover:bg-sidebar-accent
                  "
                >
                  {doc.data.title}
                </a>
              ))}
            </>
          ))}
        </nav>
      </aside>

      <!-- Placeholder -->
      <main
        class="
          flex-1 prose prose-lg max-w-none
          bg-card dark:bg-card
          p-6 rounded-lg
          shadow
          dark:prose-invert
        "
      >
        <p>Please select a topic from the sidebar to view its content.</p>
      </main>
    </div>
  </section>

  <!-- Search filtering script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('searchDocs')
      const nav = document.querySelector('aside nav')
      if (!nav || !input) return

      const headings = Array.from(nav.querySelectorAll('h4'))
      const links = Array.from(nav.querySelectorAll('a'))

      input.addEventListener('input', () => {
        const q = (input as HTMLInputElement).value.trim().toLowerCase()

        links.forEach(link => {
          link.style.display =
            link.textContent && link.textContent.toLowerCase().includes(q) ? '' : 'none'
        })

        headings.forEach(h => {
          let hasVisible = false
          let el = h.nextElementSibling
          while (el && el.tagName !== 'H4') {
            if (el.tagName === 'A' && (el as HTMLElement).style.display !== 'none') {
              hasVisible = true
              break
            }
            el = el.nextElementSibling
          }
          h.style.display = hasVisible ? '' : 'none'
        })
      })
    })
  </script>
</Layout>
